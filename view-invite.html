<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>You've Got an Invite ðŸ’Œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(180deg, rgba(255,208,229,0.06), rgba(255,232,242,0.04)); min-height:100vh; }
    .center { display:flex; align-items:center; justify-content:center; height:100vh; }
    .card { background: rgba(255,255,255,0.9); padding:24px; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,0.12); max-width:900px; width:100%; }
  </style>
</head>
<body>
  <div class="center p-4">
    <div class="card text-center">
      <h1 class="text-2xl font-bold text-[#bd1e59] mb-2">You received a Valentine's invite ðŸ’Œ</h1>
      <p class="text-gray-600 mb-4">Open the invite to see the special photo.</p>
      <div id="contentArea">
        <p class="text-sm text-gray-500">Loading...</p>
      </div>
      <div class="mt-4">
        <a id="homeLink" href="login.html" class="px-4 py-2 rounded bg-[#bd1e59] text-white">Back to Login</a>
      </div>
    </div>
  </div>

  <script>
    // parse query helper
    function getQuery() {
      const q = {};
      location.search.substring(1).split('&').forEach(pair => {
        if (!pair) return;
        const [k,v] = pair.split('=');
        q[decodeURIComponent(k)] = decodeURIComponent(v || '');
      });
      return q;
    }

    function parseInviteLink(link) {
      try {
        const url = new URL(link, location.href);
        const params = {};
        url.searchParams.forEach((v,k) => params[k]=v);
        return params;
      } catch(e) {
        // attempt to parse as query string
        const q = {};
        link.replace(/^.*\?/, '').split('&').forEach(pair => { if (!pair) return; const [k,v]=pair.split('='); q[decodeURIComponent(k)] = decodeURIComponent(v||''); });
        return q;
      }
    }

    async function openInviteFor(sender, receiver, receiverPassword) {
      const content = document.getElementById('contentArea');
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const creator = users.find(u => u.username === sender && (u.receiverUsername === receiver));
      if (!creator) {
        content.innerHTML = '<p class="text-red-600">Invite not found or it has expired.</p>';
        return;
      }

      // If receiverPassword set on creator, require match
      if (creator.receiverPassword && creator.receiverPassword !== (receiverPassword || '')) {
        content.innerHTML = '<p class="text-red-600">Incorrect receiver password.</p>';
        return;
      }

      // Use combined photo if available
      const combined = creator.photoCombined || creator.photoHer || creator.photoHim || null;
      if (!combined) {
        content.innerHTML = '<p class="text-gray-600">No photos available.</p>';
        return;
      }

      try {
        // show combined full-screen
        const overlay = document.createElement('div');
        Object.assign(overlay.style, { position:'fixed', inset:0, display:'flex', alignItems:'center', justifyContent:'center', background:'linear-gradient(180deg, rgba(189,30,89,0.16), rgba(233,30,99,0.08))', zIndex:9999, padding:'20px' });
        const imgEl = document.createElement('img'); imgEl.src = combined; Object.assign(imgEl.style, { maxWidth:'95%', maxHeight:'95%', borderRadius:'14px', boxShadow:'0 30px 80px rgba(0,0,0,0.4)', objectFit:'cover' });
        const close = document.createElement('button'); close.textContent='âœ•'; Object.assign(close.style, { position:'absolute', top:'18px', right:'18px', zIndex:10000, background:'rgba(255,255,255,0.9)', border:'none', width:'44px', height:'44px', borderRadius:'50%', cursor:'pointer', fontSize:'20px' });
        close.addEventListener('click', ()=> overlay.remove());
        overlay.appendChild(imgEl); overlay.appendChild(close); document.body.appendChild(overlay);

        content.innerHTML = `<p class="text-gray-600">Invite from <strong>${creator.fullname || creator.username}</strong></p><p class="text-sm text-gray-500 mt-2">Click âœ• to close.</p>`;
      } catch (err) {
        console.error(err); content.innerHTML = '<p class="text-red-600">Failed to load invite photo.</p>';
      }
    }

    (function(){
      const q = getQuery();
      const sender = q.sender || '';
      const receiver = q.receiver || '';
      const content = document.getElementById('contentArea');

      // If query present use it directly
      if (sender && receiver) {
        openInviteFor(sender, receiver, q.receiverPassword || '');
        return;
      }

      // No query â€” show form to paste invite link or enter credentials
      content.innerHTML = `
        <div class="max-w-md mx-auto">
          <label class="block text-sm text-gray-600 mb-2">Paste invite link</label>
          <div class="flex gap-2">
            <input id="pasteLink" class="flex-1 p-2 rounded border" placeholder="https://.../view-invite.html?sender=...&receiver=..." />
            <button id="openLinkBtn" class="px-3 py-2 rounded bg-[#bd1e59] text-white">Open</button>
          </div>
          <div class="my-4 border-t pt-4">
            <p class="text-sm text-gray-600 mb-2">Or enter details</p>
            <input id="senderInput" class="w-full p-2 rounded border mb-2" placeholder="Sender username" />
            <input id="receiverInput" class="w-full p-2 rounded border mb-2" placeholder="Receiver username" />
            <input id="receiverPassInput" type="password" class="w-full p-2 rounded border mb-2" placeholder="Receiver password" />
            <div class="flex gap-2">
              <button id="openCredBtn" class="flex-1 px-3 py-2 rounded bg-[#bd1e59] text-white">Open with credentials</button>
              <button id="clearBtn" class="flex-1 px-3 py-2 rounded bg-gray-200">Clear</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('openLinkBtn').addEventListener('click', ()=>{
        const v = document.getElementById('pasteLink').value.trim();
        if (!v) return alert('Please paste an invite link');
        const params = parseInviteLink(v);
        if (!params.sender || !params.receiver) return alert('Invalid invite link');
        openInviteFor(params.sender, params.receiver, params.receiverPassword || '');
      });

      document.getElementById('openCredBtn').addEventListener('click', ()=>{
        const s = document.getElementById('senderInput').value.trim();
        const r = document.getElementById('receiverInput').value.trim();
        const p = document.getElementById('receiverPassInput').value.trim();
        if (!s || !r) return alert('Please enter sender and receiver usernames');
        openInviteFor(s, r, p);
      });

      document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('pasteLink').value = ''; document.getElementById('senderInput').value=''; document.getElementById('receiverInput').value=''; document.getElementById('receiverPassInput').value=''; });
    })();
  </script>
</body>
</html>
