<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Recovery - Valentine's Day</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(180deg, rgba(255, 208, 229, 1) 0%, rgba(255, 232, 242, 1) 36%, rgba(255, 255, 255, 1) 100%);
      min-height: 100vh;
    }

    .form-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(189, 30, 89, 0.3);
      max-width: 500px;
    }

    .input-field {
      border: 2px solid #bd1e59;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(189, 30, 89, 0.1);
      border-color: #bd1e59;
    }

    .button-primary {
      background: linear-gradient(135deg, #bd1e59 0%, #e91e63 100%);
      transition: all 0.3s ease;
    }

    .button-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(189, 30, 89, 0.3);
    }

    .sender-photo-container {
      background: white;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(189, 30, 89, 0.2);
    }

    .sender-photo-container img {
      max-width: 100%;
      height: auto;
      max-height: 400px;
      border-radius: 10px;
      margin: 20px 0;
      border: 3px solid #bd1e59;
    }

    .recovery-photo-card {
      background: #fce4ec;
      border: 2px solid #bd1e59;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .recovery-photo-card img {
      max-width: 100%;
      height: auto;
      max-height: 250px;
      border-radius: 8px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl">
      <!-- Back Button -->
      <div class="mb-4">
        <a href="login.html" class="text-[#bd1e59] font-semibold hover:underline">‚Üê Back to Login</a>
      </div>

      <!-- Main Container -->
      <div id="step1" class="form-container">
        <h1 class="text-3xl font-bold text-[#bd1e59] mb-2 text-center">Account Recovery üíï</h1>
        <p class="text-gray-600 text-center mb-6">Enter your receiver's username to verify your identity</p>

        <form id="recoveryForm" class="space-y-6">
          <div>
            <label for="receiverUsername" class="block text-sm font-medium text-[#bd1e59] mb-2">Receiver's Username</label>
            <input
              type="text"
              id="receiverUsername"
              placeholder="Enter receiver's username"
              class="input-field w-full px-4 py-3 rounded-lg text-gray-700 placeholder-gray-400"
              required
            />
            <p class="text-xs text-gray-500 mt-2">This is the person who received your invite</p>
          </div>

          <button
            type="button"
            onclick="verifySenderPhoto()"
            class="button-primary w-full py-3 px-4 bg-[#bd1e59] text-white font-bold rounded-lg cursor-pointer"
          >
            Continue ‚Üí
          </button>
        </form>
      </div>

      <!-- Step 2: Sender Photo Verification -->
      <div id="step2" class="sender-photo-container" style="display: none;">
        <h2 class="text-2xl font-bold text-[#bd1e59] mb-4">DO YOU KNOW HIM? ü§î</h2>
        <p class="text-gray-600 mb-4">Let's verify your identity with the photo from your special someone:</p>
        
        <img id="senderPhotoDisplay" src="" alt="Sender Photo" />
        
        <p id="senderNameDisplay" class="text-lg font-semibold text-[#bd1e59] mt-4"></p>

        <div class="mt-6 space-y-3">
          <button
            type="button"
            onclick="goToPhotoRecovery()"
            class="button-primary w-full py-3 px-4 bg-[#bd1e59] text-white font-bold rounded-lg cursor-pointer"
          >
            Yes, That's Them! Continue ‚Üí
          </button>
          <button
            type="button"
            onclick="location.href='login.html'"
            class="w-full py-3 px-4 bg-gray-200 text-gray-700 font-bold rounded-lg cursor-pointer hover:bg-gray-300"
          >
            No, Go Back
          </button>
        </div>
      </div>

      <!-- Step 3: Recovery Photo Answer -->
      <div id="step3" class="form-container" style="display: none;">
        <h2 class="text-2xl font-bold text-[#bd1e59] mb-2 text-center">One Last Thing üí´</h2>
        <p class="text-gray-600 text-center mb-6">Answer this recovery question to confirm it's really you:</p>

        <div id="recoveryPhotoSection" class="space-y-6">
          <div class="recovery-photo-card">
            <p class="font-semibold text-[#bd1e59] mb-3">Do you recognize this photo?</p>
            <img id="recoveryPhotoDisplay" src="" alt="Recovery Photo" />
            <p id="recoveryPhotoLabel" class="text-sm text-gray-600 mt-2"></p>
          </div>

          <form id="recoveryAnswerForm" class="space-y-4">
            <div>
              <label for="newPassword" class="block text-sm font-medium text-[#bd1e59] mb-2">Set New Password</label>
              <input
                type="password"
                id="newPassword"
                placeholder="Enter new password"
                class="input-field w-full px-4 py-3 rounded-lg text-gray-700 placeholder-gray-400"
                required
              />
              <p class="text-xs text-gray-500 mt-1">Min. 6 characters</p>
            </div>

            <div>
              <label for="confirmPassword" class="block text-sm font-medium text-[#bd1e59] mb-2">Confirm Password</label>
              <input
                type="password"
                id="confirmPassword"
                placeholder="Confirm new password"
                class="input-field w-full px-4 py-3 rounded-lg text-gray-700 placeholder-gray-400"
                required
              />
            </div>

            <button
              type="submit"
              class="button-primary w-full py-3 px-4 bg-[#bd1e59] text-white font-bold rounded-lg cursor-pointer"
            >
              Reset Password ‚ú®
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentData = {};

    function verifySenderPhoto() {
      const receiverUsername = document.getElementById('receiverUsername').value.trim();
      if (!receiverUsername) {
        alert('Please enter receiver\'s username');
        return;
      }

      // Find the sender who has this receiver
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const sender = users.find(u => u.receiverUsername && u.receiverUsername.toLowerCase() === receiverUsername.toLowerCase());

      if (!sender) {
        alert('No invite found for this receiver username. Please check and try again.');
        return;
      }

      currentData = { sender, receiverUsername };

      // Display sender info
      document.getElementById('senderPhotoDisplay').src = sender.photoCombined || sender.photoHer || sender.photoHim || '';
      document.getElementById('senderNameDisplay').textContent = `From: ${sender.fullname}`;

      // Hide step 1, show step 2
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
      window.scrollTo(0, 0);
    }

    function goToPhotoRecovery() {
      const sender = currentData.sender;
      
      // Show the recovery photo
      const recoveryPhoto = sender.recoveryPhoto;

      if (!recoveryPhoto) {
        alert('No recovery photo available');
        return;
      }

      document.getElementById('recoveryPhotoDisplay').src = recoveryPhoto;

      // Hide step 2, show step 3
      document.getElementById('step2').style.display = 'none';
      document.getElementById('step3').style.display = 'block';
      window.scrollTo(0, 0);
    }

    document.getElementById('recoveryAnswerForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();

      if (!newPassword || !confirmPassword) {
        alert('Please fill in all fields');
        return;
      }

      if (newPassword.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }

      // Update password for the sender
      const users = JSON.parse(localStorage.getItem('users')) || [];
      const userIndex = users.findIndex(u => u.username === currentData.sender.username);

      if (userIndex === -1) {
        alert('User not found');
        return;
      }

      users[userIndex].password = newPassword;
      localStorage.setItem('users', JSON.stringify(users));

      alert('‚ú® Password reset successful! Please log in with your new password.');
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>
